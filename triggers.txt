CREATE OR REPLACE FUNCTION appstatus() RETURNS TRIGGER AS $$
DECLARE
holder_post VARCHAR;
holder_dept int;
holder_id int;
status VARCHAR;
cur_status_id int;
BEGIN
if NEW.action_taken ='backward' then
  if NEW.post = 'Director' Then
    select into holder_post faculty.post from application, faculty where application.faculty_id=faculty.faculty_id and application.application_id=NEW.application_id;
  else
    select into holder_post sender from application_route where application_route.receiver=NEW.post;
  end if;
elseif NEW.action_taken = 'submitted' and NEW.post <> 'Faculty' Then
  holder_post = 'Director';
else
  select into holder_post receiver from application_route where application_route.sender=NEW.post;
end if;
if holder_post = NULL Then
  status = 'Passed';
else
  status = 'Pending';
end if;
if holder_post = 'HOD' then
  select into holder_dept faculty.department_id from application, faculty, application_log where application_log.application_id=application.application_id and application.faculty_id=faculty.faculty_id and application_log.application_id=NEW.application_id;
  select into holder_id hod.faculty_id from hod where hod.dept_id = holder_dept;
else
  select into holder_id special_posts.faculty_id from special_posts where special_posts.post=holder_post;
END if;
select into cur_status_id status_id from current_status where current_status.status_id=NEW.application_id;
if cur_status_id = NULL Then
  INSERT INTO current_status(status_id, current_holder_post, current_holder_id, status, borrowed_leaves) values (NEW.application_id, holder_post, holder_id,status,0);
else
  UPDATE current_status set current_holder_post=holder_post, current_holder_id=holder_id, status=status where status_id=cur_status_id;
end if;
RETURN NEW;
END; $$
LANGUAGE PLPGSQL;


CREATE TRIGGER app_status AFTER INSERT ON application_log
FOR EACH ROW EXECUTE PROCEDURE appstatus();

CREATE OR REPLACE FUNCTION updatehod(dept_name_ch text, faculty_id_ch int) RETURNS void AS $$
DECLARE
dept_id_ch int;
old_faculty int;
BEGIN
  select into dept_id_ch department_id from department where dept_name=dept_name_ch;
  select into old_faculty faculty_id from hod_logs where dept_id=dept_id_ch;
  if old_faculty = NULL Then
    INSERT INTO hod(dept_id,faculty_id) values(dept_id_ch, faculty_id_ch);
    INSERT INTO hod_logs(faculty_id,dept_id,start_date) values(faculty_id_ch, dept_id_ch, NOW());
    UPDATE faculty set post='HOD' where faculty_id=faculty_id_ch;
  end if;
  UPDATE hod set faculty_id=faculty_id_ch where dept_id=dept_id_ch;
  UPDATE hod_logs set end_date=NOW() where faculty_id=old_faculty;
  UPDATE faculty set post='HOD' where faculty_id=faculty_id_ch;
  UPDATE faculty set post='Faculty' where faculty_id=old_faculty;
  INSERT INTO hod_logs(faculty_id,dept_id,start_date) values(faculty_id_ch, dept_id_ch, NOW());
END; $$
LANGUAGE PLPGSQL;
